<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>File API Operation</title>
    <style>
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
        }

        /* Separate rule for compatibility, :focus-within is required on modern Firefox and Chrome */
        input.visually-hidden:focus + label {
            outline: thin dotted;
        }

        input.visually-hidden:focus-within + label {
            outline: thin dotted;
        }
    </style>
</head>
<body>
<div onload="">
    <input type="file" multiple id="input" accept="image/*" class="visually-hidden"/>
    <label for="input">Upload Click Me</label>
    <div id="preview"></div>
</div>
<script charset="utf-8">
    // chunk size
    const chunkSize = 1024000;

    // 创建 hash worker
    const hashWorker = new Worker("hash-worker.js");
    hashWorker.onmessage = function (e) {
        console.log(e.data)
    }

    const inputElement = document.getElementById("input");
    inputElement.addEventListener("change", handleFiles, false);

    async function handleFiles() {
        for (let i = 0; i < this.files.length; i++) {
            // display preview image
            if (!this.files[i].type.startsWith('image/')) continue;
            const img = document.createElement("img");
            img.classList.add("obj");
            img.file = this.files[i];
            const fileReader = new FileReader();
            fileReader.onload = (function (aImg) {
                return function (e) {
                    aImg.src = e.target.result;
                };
            })(img);
            fileReader.readAsDataURL(this.files[i]);
            const preview = document.getElementById("preview");
            preview.appendChild(img);

            // slice file
            for (let j = 0; j < this.files[i].size; j += chunkSize) {
                const blob = this.files[i].slice(j, j + chunkSize);
                hashWorker.postMessage(blob);
            }
        }
    }
</script>
</body>
</html>
